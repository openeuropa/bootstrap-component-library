/* stylelint-disable no-descending-specificity, declaration-no-important */

/* -------------------------------------
   Design tokens & helpers
-------------------------------------- */
$mm-panel-height: 288px !default;
$mm-z-content: 2 !default;
$mm-z-overlay: 1060 !default;
$mm-z-header: 1070 !default;
$mm-gutter-x: map-get($spacers, 3) !default;
$mm-gutter-y: map-get($spacers, "2-5") !default;

/* Helpers */
@mixin nav-items {
  > a,
  > button,
  > span,
  li > a,
  li > button {
    @content;
  }
}

@mixin link-reset {
  text-decoration: none;
  &:hover {
    text-decoration: underline;
  }
}

@mixin focus-ring {
  outline: 2px solid $primary;
  outline-offset: 2px;
}

@mixin mm-item-padding($py: $mm-gutter-y, $px: $mm-gutter-x) {
  padding: $py $px;
}

/* -------------------------------------
   Component
-------------------------------------- */
.bcl-mega-menu {
  /* Low-specificity defaults for interactive elements inside the component */
  :where(a, button) {
    @include link-reset;
    &:focus-visible {
      @include focus-ring;
    }
  }

  &.nav-link {
    padding: 0;
  }

  /* When toggle is expanded, show menu. Use ARIA state instead of .show sibling hacks. */
  @include media-breakpoint-up(lg) {
    [aria-expanded="true"] + .mega-menu-container.dropdown-menu {
      display: flex;
    }
  }
  @include media-breakpoint-down(lg) {
    [aria-expanded="true"] + .mega-menu-container.dropdown-menu {
      display: block;
    }
  }

  .mega-menu-container.dropdown-menu {
    position: absolute;
    inset-block-start: 0;
    inset-inline-start: 0;
    display: none;
    inline-size: 100%;
    margin-block-start: 0;
    padding: 0;
    border: 0;
    border-radius: 0;

    .back-button-block {
      position: relative;
      padding: 20px map-get($spacers, 1) 0;
      background: $primary-bg-subtle;

      .btn-link {
        @include link-reset;
      }
    }

    > .row {
      flex: 1;
    }

    .content-block {
      position: relative;
      padding: $mm-gutter-x;
      background: $primary-bg-subtle;
    }

    .content-link {
      @include link-reset;
    }

    /* ---------------------------------
       LEFT column – vertical tablist
    ---------------------------------- */
    .navigation-items {
      position: relative;
      list-style: none;
      overflow: auto;
      padding-inline-start: 0;

      @include nav-items {
        display: block;
        position: relative;
        color: $dark;

        &:has(svg) {
          padding-inline-end: map-get($spacers, 5);
        }
      }

      > span {
        text-decoration: none;
        color: $dark;
        @include mm-item-padding();
        display: block;
      }

      > a[role="tab"] {
        @include mm-item-padding($mm-gutter-y, map-get($spacers, 5));
        padding-inline-start: $mm-gutter-x;

        &.active,
        &[aria-selected="true"] {
          pointer-events: none;
          background: $primary-bg-subtle;
        }

        > svg {
          position: absolute;
          inset-inline-end: 20px;
          inset-block-start: 50%;
          transform: translateY(-50%);
        }

        &:after {
          display: none;
        }
      }

      > a {
        color: $link-color;

        &:hover {
          text-decoration: underline;
        }

        &.tab-toggle {
          color: $dark;

          &:hover {
            text-decoration: none;
          }
        }
      }
    }

    /* ---------------------------------
       RIGHT column – tab panels
    ---------------------------------- */
    .sub-navigation-items.tab-content {
      position: relative;

      .tab-pane {
        padding: $mm-gutter-x;

        ul {
          &:has(.see-all-button) {
            li:nth-last-child(2) {
              a {
                border-bottom: 0;
              }
            }
          }
        }

        li {
          list-style: none;

          > * {
            display: block;
            @include mm-item-padding();
            color: $dark;
            border-bottom: 1px solid $primary-bg-subtle;
          }

          > a {
            color: $link-color;
            text-decoration: none;

            &:hover {
              text-decoration: underline;
            }
          }

          &:last-child {
            a {
              border-bottom: 0;
            }
          }

          .see-all-button {
            border-bottom: 0;
            position: relative;
            padding-block: $mm-gutter-y;
            padding-inline: 0;
            display: flex;
            align-items: center;
            margin: 0;

            &:after {
              background: $neutral-border-color;
              content: "";
              block-size: 1px;
              inset-inline-start: 0;
              position: absolute;
              inset-block-start: 0;
              inline-size: 100%;
            }

            svg {
              inline-size: 0.8rem;
              flex-shrink: 0;
            }

            span {
              text-overflow: ellipsis;
              overflow: hidden;
              display: block;
              white-space: nowrap;
            }
          }

          &:has(.see-all-button) {
            margin: 0 map-get($spacers, "4-25");
            position: sticky;
            inset-block-start: 100%;
          }
        }
      }

      .panel-title {
        display: none;
      }
    }
  }
}

/* -------------------------------------
   lg+ layout
-------------------------------------- */
@include media-breakpoint-up(lg) {
  .nav-item:has(> .bcl-mega-menu) {
    position: static;
  }

  .bcl-mega-menu {
    .mega-menu-container.dropdown-menu {
      inset-block-start: 100%;
      padding-block: map-get($spacers, "2-5");
      border-bottom: var(--bs-border-width) var(--bs-border-style)
        var(--bs-border-color);

      .shadow-container {
        position: relative;

        .shadow-bg {
          position: absolute;
          inset-inline-start: 50%;
          inset-block-end: 0;
          inline-size: 100vw;
          block-size: 8px;
          transform: translateX(-50%);
          box-shadow: 0 4px 5px 0 rgba(224, 229, 245, 0.5);
        }
      }

      .content-block {
        margin-inline-end: 0;
        background: $white;
        padding-inline-end: map-get($spacers, 4);
      }

      .navigation-items {
        @include nav-items {
          &:hover {
            background: $primary-bg-subtle;
          }
        }

        > a,
        > span {
          @include mm-item-padding();
        }

        > a[role="tab"].active,
        > a[role="tab"][aria-selected="true"] {
          background: $primary-bg-subtle;
          pointer-events: none;
          border-inline-start: 4px solid $primary;
          padding-inline-start: $mm-gutter-y;
          padding-inline-end: map-get($spacers, 5);
        }
      }

      .sub-navigation-items.tab-content {
        overflow-y: auto;

        &:has(> .active) {
          background: $primary-bg-subtle;
        }

        .tab-pane {
          overflow-y: auto;
          padding: $mm-gutter-x;

          li {
            > * {
              border-bottom: none;
            }
          }
        }
      }
    }
  }
}

/* -------------------------------------
   xl+
-------------------------------------- */
@include media-breakpoint-up(xl) {
  .bcl-mega-menu {
    .mega-menu-container.dropdown-menu {
      .content-block {
        box-shadow: none;
      }

      .shadow-container {
        block-size: 100%;
        position: absolute;
        inset-inline-end: 0;
        inset-block-start: 0;

        .shadow-bg {
          inset-inline-start: auto;
          inset-inline-end: 0;
          block-size: 100%;
          inline-size: 10px;
          transform: none;
          box-shadow: 4px 3px 4px 0 rgba(224, 229, 245, 0.5);
        }
      }

      .sub-navigation-items.tab-content {
        .tab-pane {
          li {
            > * {
              margin: 0 map-get($spacers, "2-5");
            }
          }
        }
      }
    }
  }

  /* -------------------------------------
    White overlay when mega menu is open
    (kept with :has for convenience; consider JS class .mm-open for perf)
  -------------------------------------- */
  body {
    &:has(.mega-menu-container.show) {
      overflow: hidden;

      main {
        &:after {
          position: absolute;
          inset: 0;
          background: #fff;
          opacity: 0.5;
          content: "";
          z-index: $mm-z-overlay;
        }
      }

      header {
        position: relative;
        z-index: $mm-z-header;
      }
    }
  }
}

/* -------------------------------------
   Mechanism on mobile to show/hide panels
-------------------------------------- */
@include media-breakpoint-down(lg) {
  .bcl-mega-menu {
    .mega-menu-container.dropdown-menu {
      &:has(.navigation-items > .active) {
        .content-block {
          display: none;
        }
      }

      .navigation-items {
        &:has(> .active) {
          display: none;
        }
      }

      .sub-navigation-items.tab-content {
        .panel-title {
          @include mm-item-padding(map-get($spacers, 3));
          margin: 0;
          color: $dark;
          background: $primary-bg-subtle;
          display: block;
          font-size: 20px;
        }

        .tab-pane {
          > li {
            > * {
              border-bottom: 1px solid $primary-bg-subtle;
            }
          }

          li {
            &:has(.see-all-button) {
              margin: 0;

              .see-all-button {
                @include mm-item-padding();
              }
            }
          }
        }
      }
    }

    /* Hide toggle when open (ARIA-driven) */
    [aria-expanded="true"].dropdown-toggle {
      display: none;
    }

    .panel-title,
    .content-block,
    .back-button-block {
      position: relative;

      &::after {
        position: absolute;
        inset-inline-start: 50%;
        content: "";
        background: $primary-bg-subtle;
        inline-size: 100vw;
        block-size: 100%;
        inset-block-start: 0;
        z-index: -1;
        transform: translateX(-50%);
      }
    }
  }
}

/* -------------------------------------
    Fixes for height issues
-------------------------------------- */
@include media-breakpoint-up(lg) {
  .bcl-mega-menu {
    .mega-menu-container.dropdown-menu {
      .sub-navigation-items.tab-content {
        .tab-pane {
          ul {
            block-size: $mm-panel-height;
          }
        }
      }
    }

    .content-block {
      max-block-size: $mm-panel-height;
      overflow: auto;
    }

    .navigation-items {
      block-size: $mm-panel-height;
    }
  }
}

/* -------------------------------------
   Motion preferences (subtle transitions)
-------------------------------------- */
@media (prefers-reduced-motion: no-preference) {
  .bcl-mega-menu .mega-menu-container.dropdown-menu {
    transition:
      opacity 0.15s ease,
      transform 0.15s ease;
  }

  .bcl-mega-menu [aria-expanded="true"] + .mega-menu-container.dropdown-menu {
    opacity: 1;
    transform: none;
  }

  .bcl-mega-menu [aria-expanded="false"] + .mega-menu-container.dropdown-menu {
    opacity: 0;
    transform: translateY(-4px);
    pointer-events: none;
  }
}
